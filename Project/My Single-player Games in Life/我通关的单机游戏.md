```dataviewjs
// ================= é…ç½®åŒºåŸŸ =================

const sourceTag = '#æ¸¸æˆè®°å½•';

// ã€ä¿®æ”¹ç‚¹ã€‘æ’åºä¾æ®æ”¹ä¸ºä¸­æ–‡åï¼Œé€†åºä¸ºdescï¼Œé¡ºåºä¸ºasc
// é€‰é¡¹: 'æ—¶é•¿', 'è¯„åˆ†', 'é€šå…³æ—¥æœŸ'ï¼Œ'åºå·'
const sortKey = 'åºå·';
const sortOrder = 'asc';

// ===========================================

let pages = dv.pages(sourceTag)
    .filter(p => !p.file.name.includes("Template") && p.file.name !== "æœªå‘½å");

// --- å›¾ç‰‡è·¯å¾„è½¬æ¢å‡½æ•° ---
function getImageUrl(imagePath) {
    if (!imagePath) return "";
    if (typeof imagePath === 'string' && imagePath.startsWith('http')) return imagePath;
    let filename = imagePath;
    if (imagePath.path) filename = imagePath.path;
    const file = app.metadataCache.getFirstLinkpathDest(filename, "");
    if (file) return app.vault.getResourcePath(file);
    return "";
}

// --- æ—¥æœŸæ ¼å¼åŒ– ---
function formatDate(date) {
    if (!date) return '-';
    
    // 1. å¦‚æœæ˜¯æ­£å¸¸çš„ Dataview æ—¶é—´å¯¹è±¡ (Luxon DateTime)
    if (date.toFormat) return date.toFormat("yyyy-MM-dd");
    
    // 2. å°†å±æ€§è½¬åŒ–ä¸ºå­—ç¬¦ä¸²å¹¶å»é™¤é¦–å°¾ç©ºæ ¼
    const dateStr = String(date).trim();
    
    // 3. ä½¿ç”¨æ­£åˆ™æå–å¹´ã€æœˆã€æ—¥
    // æ”¯æŒçš„æ ¼å¼åŒ…æ‹¬ï¼š2021.6.6 | 2021-6-6 | 2021/6/6 | 2021å¹´6æœˆ6æ—¥
    const regex = /^(\d{4})[./\-å¹´](\d{1,2})[./\-æœˆ](\d{1,2})/;
    const match = dateStr.match(regex);
    
    if (match) {
        const year = match[1];
        // padStart(2, '0') çš„ä½œç”¨æ˜¯å¦‚æœåªæœ‰1ä½æ•°å­—ï¼ˆå¦‚ 6ï¼‰ï¼Œå‰é¢è‡ªåŠ¨è¡¥ 0ï¼ˆå˜æˆ 06ï¼‰
        const month = match[2].padStart(2, '0');
        const day = match[3].padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    return '-';
}

if (pages.length === 0) {
    dv.header(3, "âš ï¸ æ²¡æ‰¾åˆ°ç¬”è®°");
    dv.paragraph(`è¯·ç¡®ä¿ç¬”è®°åŒ…å«æ ‡ç­¾ï¼š**${sourceTag}**`);
} else {
    // ã€ä¿®æ”¹ç‚¹ã€‘æ’åºé€»è¾‘é€‚é…ä¸­æ–‡å±æ€§
    // ä½¿ç”¨ page["å±æ€§å"] çš„æ–¹å¼è¯»å–ä¸­æ–‡å±æ€§
    if (sortKey === 'æ—¶é•¿') {
        pages = pages.sort(p => parseFloat(p["æ—¶é•¿"]), sortOrder);
    } else if (sortKey === 'è¯„åˆ†') {
        pages = pages.sort(p => p["è¯„åˆ†"], sortOrder);
    } else if (sortKey === 'åºå·') {
        // è¿™é‡Œæ–°å¢äº†å¯¹åºå·çš„å¤„ç†
        pages = pages.sort(p => p["åºå·"], sortOrder);
    } else {
        pages = pages.sort(p => p["é€šå…³æ—¥æœŸ"], sortOrder);
    }

    const container = document.createElement("div");
    container.className = "game-gallery";
    dv.container.appendChild(container);

    function getStars(rating) {
        const stars = Math.round((rating || 0) / 2);
        return "â˜…".repeat(stars) + "â˜†".repeat(5 - stars);
    }

    pages.forEach((page, index) => {
        // ã€ä¿®æ”¹ç‚¹ã€‘è¯»å–ä¸­æ–‡å±æ€§
        let coverUrl = getImageUrl(page["å°é¢"]);
        let displayTags = page.tags || [];
        if (typeof displayTags === 'string') displayTags = [displayTags];
        const tagsHtml = displayTags
            .filter(t => t !== 'æ¸¸æˆè®°å½•')
            .map(t => `<span class="game-tag">${t}</span>`)
            .join('');

        const card = document.createElement("div");
        card.className = "game-card";
        
        // æ³¨æ„ï¼šè¿™é‡Œçš„æ’å #${index + 1} æ˜¯æŒ‰ç…§ä½ æ’åºåçš„é¡ºåºæ˜¾ç¤ºçš„
        // å¦‚æœä½ æƒ³æ˜¾ç¤ºç¬”è®°é‡ŒåŸæœ¬çš„åºå·ï¼Œå¯ä»¥å°† ${index + 1} æ”¹ä¸º ${page["åºå·"]}
        card.innerHTML = `
            <div class="game-card-cover" style="background-image: url('${coverUrl}');">
                <div class="game-rank">#${page["åºå·"] || (index + 1)}</div>
                <div class="game-score-badge">${page["è¯„åˆ†"] || '-'}</div>
            </div>
            <div class="game-card-content">
                <div class="game-title-cn">${page["ä¸­æ–‡å"] || page.file.name}</div>
                <div class="game-title-en">${page["è‹±æ–‡å"] || ''}</div>
                <div class="game-stars">${getStars(page["è¯„åˆ†"])}</div>
                <div class="game-tags">${tagsHtml}</div>

                <div class="game-meta-row">
                    ${page["é€šå…³æ—¶é•¿"] ? `<div class="game-meta-item" title="é€šå…³æ—¶é•¿">ğŸ•’ ${String(page["é€šå…³æ—¶é•¿"] || '-').replace('PT','').replace('H','h')}</div>` : ''}
                    ${page["ç™½é‡‘æ—¶é•¿"] ? `<div class="game-meta-item" title="ç™½é‡‘æ—¶é•¿">ğŸ† ${String(page["ç™½é‡‘æ—¶é•¿"]).replace('PT','').replace('H','h')}</div>` : ''}
                    ${page["å…¨æ”¶é›†æ—¶é•¿"] ? `<div class="game-meta-item" title="å…¨æ”¶é›†æ—¶é•¿">ğŸ† ${String(page["å…¨æ”¶é›†æ—¶é•¿"]).replace('PT','').replace('H','h')}</div>` : ''}
                    <div class="game-meta-item" title="å¹³å°">ğŸ® ${page["å¹³å°"] || 'PC'}</div>
                    <div class="game-meta-item" title="é€šå…³æ—¥æœŸ">ğŸ“… ${formatDate(page["é€šå…³æ—¥æœŸ"])}</div>
                </div>
            </div>
        `;

        card.onclick = (e) => {
            e.preventDefault();
            app.workspace.openLinkText(page.file.path, "", false);
        };
        container.appendChild(card);
    });
}
```

