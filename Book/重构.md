# 重构 改善既有代码的设计

### 何时重构

- 先重构，再进行性能优化
- 第一次做某事时只管去做；第二次做类似的事会产生反感，但还是可以做；第三次再做类似的事情，就应该重构。
- 只有判断当未来重构会很困难时，才考虑现在就添加灵活性机制。

### 代码坏味道

#### 发散式变化

应该每次只关注一个地方。

#### 霰弹式修改

应该把要修改的代码放到一个模块

#### 夸夸其谈通用性

#### 注释

1. 如果需要注释来解释一块代码做了什么，试试**提炼函数**
2. 如果提炼出来的函数还需要注释解释，试试**改名**
3. 用**断言**取代注释来解释系统的需求规格
4. 如果你不知道该做什么，这才是用注释的良好时机
5. 最后可以用注释写下“为什么做某某事“

### 一些需要重视的重构方法

#### 提炼类

- 当函数或类的代码逐渐膨胀，抽象地提炼出来一个类总是很好的。
- 如果发现一组函数形影不离地操作同一块数据，就应该考虑组建成一个类，给这些函数提供一个共用的环境。

#### 隐藏委托关系

本质是一种封装

如

```js
manager = aPerson.department.manager.
```

重构：
```js
manager = aPerson.manager;

class Person {
    get manager() { return this.department.manager; }
```

#### 拆分循环

同一个循环做了多件事，可以牺牲一点性能，拆分成同样的多个循环，能大大提高可读性

#### 保持对象完整

对应的坏味道：从一个对象中抽取几个值，单独对这几个值做某些逻辑操作。